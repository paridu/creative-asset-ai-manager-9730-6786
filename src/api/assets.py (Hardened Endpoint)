from fastapi import APIRouter, Depends, Security
from src.security.auth import get_current_user
from src.security.storage_vault import IPProtector

router = APIRouter(prefix="/assets", tags=["Secure Assets"])
protector = IPProtector()

@router.get("/{asset_id}/stream")
async def get_asset_secure_link(
    asset_id: str, 
    current_user: str = Depends(get_current_user)
):
    """
    Instead of returning a static file path, returns a temporary 
    pre-signed URL valid only for the authenticated session.
    """
    # 1. Verify ownership in DB
    asset = await db.assets.get_by_id_and_owner(asset_id, current_user)
    if not asset:
        raise HTTPException(status_code=404, detail="Asset not found or unauthorized")

    # 2. Generate temporary access
    secure_url = protector.generate_secure_url(asset.storage_key)
    
    # 3. Log Access for Audit
    await db.audit.log(user_id=current_user, asset_id=asset_id, action="ACCESS_PREVIEW")
    
    return {"secure_url": secure_url}